<?php
// Panel Admin Main Entry Point
session_start();

// Set timezone
date_default_timezone_set('Asia/Jakarta');

// Enable error reporting for development
error_reporting(E_ALL);
ini_set('display_errors', 1);

// Include database configuration
require_once __DIR__ . '/../../shared/config/database.php';

// Define base path
define('BASE_PATH', '/panel-dropship-admin');
define('VIEWS_PATH', __DIR__ . '/../views');
define('INCLUDES_PATH', __DIR__ . '/../includes');

// Simple routing
$request_uri = $_SERVER['REQUEST_URI'];
$script_name = $_SERVER['SCRIPT_NAME'];

// Remove base path and script name
$path = str_replace([dirname($script_name), 'api/'], '', $request_uri);
$path = trim($path, '/');

// Parse query string
$query_string = $_SERVER['QUERY_STRING'] ?? '';
parse_str($query_string, $query_params);

// Get request method
$method = $_SERVER['REQUEST_METHOD'];

// Include helper functions
if (file_exists(INCLUDES_PATH . '/functions.php')) {
    require_once INCLUDES_PATH . '/functions.php';
}

// Route definitions
$routes = [
    // Auth routes
    '' => 'dashboard',
    'login' => 'auth/login',
    'logout' => 'auth/logout',
    
    // Dashboard
    'dashboard' => 'dashboard/main',
    
    // Products
    'products' => 'products/list',
    'products/add' => 'products/add',
    'products/edit' => 'products/edit',
    'products/delete' => 'products/delete',
    
    // Orders
    'orders' => 'orders/list',
    'orders/view' => 'orders/detail',
    'orders/update' => 'orders/update',
    
    // Customers
    'customers' => 'customers/list',
    
    // Suppliers
    'suppliers' => 'suppliers/list',
    
    // API endpoints
    'api/products' => 'api/products',
    'api/orders' => 'api/orders',
];

// Route the request
if (empty($path)) {
    $path = 'dashboard';
}

// Check if route exists
$route_found = false;
$route_handler = null;

foreach ($routes as $route => $handler) {
    if ($path === $route || strpos($path, $route . '/') === 0) {
        $route_found = true;
        $route_handler = $handler;
        break;
    }
}

if (!$route_found) {
    // Try direct file inclusion
    $direct_path = VIEWS_PATH . '/' . str_replace('/', DIRECTORY_SEPARATOR, $path) . '.php';
    if (file_exists($direct_path)) {
        require_once $direct_path;
        exit;
    }
    
    // 404 Not Found
    http_response_code(404);
    require_once VIEWS_PATH . '/404.php';
    exit;
}

// Handle the route
$handler_parts = explode('/', $route_handler);
$handler_type = $handler_parts[0];
$handler_file = $handler_parts[1] ?? 'index';

switch ($handler_type) {
    case 'auth':
        require_once INCLUDES_PATH . '/auth-check.php';
        $auth_file = VIEWS_PATH . '/auth/' . $handler_file . '.php';
        if (file_exists($auth_file)) {
            require_once $auth_file;
        } else {
            // Default to login
            require_once VIEWS_PATH . '/auth/login.php';
        }
        break;
        
    case 'dashboard':
        require_once INCLUDES_PATH . '/auth-check.php';
        require_once VIEWS_PATH . '/dashboard/' . $handler_file . '.php';
        break;
        
    case 'products':
    case 'orders':
    case 'customers':
    case 'suppliers':
        require_once INCLUDES_PATH . '/auth-check.php';
        $category = $handler_type;
        $action = $handler_file;
        $action_file = VIEWS_PATH . '/' . $category . '/' . $action . '.php';
        if (file_exists($action_file)) {
            require_once $action_file;
        } else {
            // Default list view
            require_once VIEWS_PATH . '/' . $category . '/list.php';
        }
        break;
        
    case 'api':
        // API endpoints - return JSON
        header('Content-Type: application/json');
        $api_file = __DIR__ . '/' . $handler_file . '.php';
        if (file_exists($api_file)) {
            require_once $api_file;
        } else {
            echo json_encode(['error' => 'API endpoint not found']);
            http_response_code(404);
        }
        break;
        
    default:
        http_response_code(404);
        require_once VIEWS_PATH . '/404.php';
}
?>
